<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Line Item Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="max-w-sm w-full bg-white p-4 rounded shadow">
      <h1 class="text-lg font-semibold mb-3 text-center">
        Створення рекламного слота
      </h1>
      <form id="lineItemForm" class="space-y-3 text-xs relative pb-1.5">
        <div class="flex gap-2">
          <input
            type="number"
            id="width"
            name="width"
            placeholder="Ширина"
            class="w-1/2 p-1 border rounded"
            required
            min="0"
          />
          <input
            type="number"
            id="height"
            name="height"
            placeholder="Висота"
            class="w-1/2 p-1 border rounded"
            required
            min="0"
          />
        </div>

        <input
          type="number"
          step="0.01"
          id="minCPM"
          name="minCPM"
          placeholder="Мінімальний CPM"
          class="w-full p-1 border rounded"
          required
          min="0"
        />
        <input
          type="number"
          step="0.01"
          id="maxCPM"
          name="maxCPM"
          placeholder="Максимальний CPM"
          class="w-full p-1 border rounded"
          required
          min="0"
        />

        <select id="geo" name="geo" class="w-full p-1 border rounded" required>
          <option value="" disabled selected>Оберіть країну</option>
          <option value="ALL">Всі країни</option>
          <option value="UA">Україна</option>
          <option value="PL">Польща</option>
          <option value="US">США</option>
          <option value="DE">Німеччина</option>
          <option value="FR">Франція</option>
          <option value="GB">Велика Британія</option>
          <option value="IT">Італія</option>
          <option value="ES">Іспанія</option>
          <option value="CA">Канада</option>
          <option value="AU">Австралія</option>
          <option value="BR">Бразилія</option>
          <option value="IN">Індія</option>
          <option value="CN">Китай</option>
          <option value="JP">Японія</option>
          <option value="KR">Південна Корея</option>
          <option value="MX">Мексика</option>
          <option value="NL">Нідерланди</option>
          <option value="SE">Швеція</option>
          <option value="CH">Швейцарія</option>
          <option value="TR">Туреччина</option>
        </select>

        <select
          id="adType"
          name="adType"
          class="w-full p-1 border rounded"
          required
        >
          <option value="" disabled selected>Тип реклами</option>
          <option value="banner">Banner</option>
        </select>

        <select
          id="frequency"
          name="frequency"
          class="w-full p-1 border rounded"
          required
        >
          <option value="" disabled selected>Частота показів</option>
          <option value="always">На кожне завантаження</option>
          <option value="hourly">Раз на годину</option>
          <option value="daily">Раз на день</option>
        </select>

        <div
          id="dropZone"
          class="relative border-2 border-dashed border-gray-400 p-4 text-center rounded bg-gray-50 text-xs flex flex-col items-center justify-center min-h-[160px]"
        >
          <span id="dropText"
            >Перетягніть файл сюди або натисніть для вибору</span
          >
          <input
            type="file"
            id="creativeFile"
            name="creativeFile"
            class="hidden"
          />
          <img
            id="previewImage"
            class="absolute inset-0 object-contain max-h-full mx-auto hidden"
          />
          <p
            id="errorMessage"
            class="absolute top-full left-1/2 -translate-x-1/2 text-red-500 text-xs whitespace-nowrap pointer-events-none hidden"
          >
            Завантажте креатив перед відправкою
          </p>
        </div>

        <div class="flex justify-center pt-2 relative">
          <button
            type="submit"
            class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700"
          >
            Submit
          </button>
          <span
            id="successMessage"
            class="absolute top-full left-1/2 -translate-x-1/2 text-green-600 text-xs whitespace-nowrap hidden"
            >Форма успішно надіслана!</span
          >
          <span
            id="failMessage"
            class="absolute top-full left-1/2 -translate-x-1/2 text-red-600 text-xs whitespace-nowrap hidden"
            >Сталася помилка при надсиланні</span
          >
        </div>
      </form>
    </div>

    <script>
      const form = document.getElementById("lineItemForm");
      const dropZone = document.getElementById("dropZone");
      const creativeInput = document.getElementById("creativeFile");
      const previewImage = document.getElementById("previewImage");
      const dropText = document.getElementById("dropText");
      const errorMessage = document.getElementById("errorMessage");
      const successMessage = document.getElementById("successMessage");
      const failMessage = document.getElementById("failMessage");

      dropZone.addEventListener("click", () => creativeInput.click());
      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("bg-blue-100");
      });
      dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("bg-blue-100");
      });
      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("bg-blue-100");
        creativeInput.files = e.dataTransfer.files;
        showPreview(creativeInput.files[0]);
        if (creativeInput.files.length > 0)
          errorMessage.classList.add("hidden");
      });

      creativeInput.addEventListener("change", () => {
        showPreview(creativeInput.files[0]);
        if (creativeInput.files.length > 0)
          errorMessage.classList.add("hidden");
      });

      function showPreview(file) {
        if (file && file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = () => {
            previewImage.src = reader.result;
            previewImage.classList.remove("hidden");
            dropText.classList.add("hidden");
          };
          reader.readAsDataURL(file);
        } else {
          previewImage.classList.add("hidden");
          previewImage.src = "";
          dropText.classList.remove("hidden");
        }
      }

      function showMessage(el) {
        el.classList.remove("hidden");
        setTimeout(() => el.classList.add("hidden"), 3000);
      }

      function resetForm() {
        form.reset();
        creativeInput.value = null;
        previewImage.src = "";
        previewImage.classList.add("hidden");
        dropText.classList.remove("hidden");
        errorMessage.classList.add("hidden");
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        successMessage.classList.add("hidden");
        failMessage.classList.add("hidden");

        if (!creativeInput.files || creativeInput.files.length === 0) {
          errorMessage.classList.remove("hidden");
          return;
        }

        const formData = new FormData();
        [
          "width",
          "height",
          "minCPM",
          "maxCPM",
          "geo",
          "adType",
          "frequency",
        ].forEach((id) => {
          formData.append(id, document.getElementById(id).value);
        });
        formData.append("creativeFile", creativeInput.files[0]);

        try {
          const res = await fetch(
            "https://adtelligent-backend-production.up.railway.app/submit",
            {
              method: "POST",
              body: formData,
            }
          );

          if (res.ok) {
            resetForm();
            showMessage(successMessage);
          } else {
            showMessage(failMessage);
          }
        } catch (err) {
          console.error("Fetch error:", err);
          showMessage(failMessage);
        }
      });
    </script>
  </body>
</html>
